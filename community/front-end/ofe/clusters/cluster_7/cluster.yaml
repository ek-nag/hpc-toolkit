
blueprint_name: cluster-046885a3

vars:
  project_id: eimantask-personal-project
  deployment_name: cluster-046885a3
  region: us-east1
  zone: us-east1-b
  enable_reconfigure: True
  enable_cleanup_compute: False
  enable_cleanup_subscriptions: True
  enable_bigquery_load: False
  instance_image_custom: True
  labels:
    created_by: aicluster-server

deployment_groups:
- group: primary
  modules:
  - source: modules/network/pre-existing-vpc
    kind: terraform
    settings:
      network_name: legible-polliwog-network
      subnetwork_name: legible-polliwog-subnet-2
    id: hpc_network


  - source: modules/file-system/pre-existing-network-storage
    kind: terraform
    id: mount_num_0
    settings:
      server_ip: '$controller'
      remote_mount: /opt/cluster
      local_mount: /opt/cluster
      mount_options: defaults,nofail,nosuid
      fs_type: nfs



  - source: modules/file-system/pre-existing-network-storage
    kind: terraform
    id: mount_num_1
    settings:
      server_ip: '$controller'
      remote_mount: /home
      local_mount: /home
      mount_options: defaults,nofail,nosuid
      fs_type: nfs


  - source: community/modules/project/service-account
    kind: terraform
    id: hpc_service_account
    settings:
      project_id: eimantask-personal-project
      name: sa
      project_roles:
      - compute.instanceAdmin.v1
      - iam.serviceAccountUser
      - monitoring.metricWriter
      - logging.logWriter
      - storage.objectAdmin
      - pubsub.admin
      - compute.securityAdmin
      - iam.serviceAccountAdmin
      - resourcemanager.projectIamAdmin
      - compute.networkAdmin


  - source: community/modules/compute/schedmd-slurm-gcp-v5-partition
    kind: terraform
    id: partition_0
    use:
    - partition_0-group
    - hpc_network
    - mount_num_0
    - mount_num_1
    settings:
      partition_name: batch
      subnetwork_self_link: legible-polliwog-subnet-2
      enable_placement: False
      exclusive: False
  - source: community/modules/compute/schedmd-slurm-gcp-v5-node-group
    id: partition_0-group
    use:
    - hpc_network
    - mount_num_0
    - mount_num_1
    settings:
      enable_smt: False
      machine_type: c2-standard-60
      node_count_dynamic_max: 4
      node_count_static: 0
      disk_size_gb: 50
      disk_type: pd-standard
      
      




  - source: community/modules/scheduler/schedmd-slurm-gcp-v5-controller
    kind: terraform
    id: slurm_controller
    settings:
      cloud_parameters:
        resume_rate: 0
        resume_timeout: 500
        suspend_rate: 0
        suspend_timeout: 300
        no_comma_params: false
      machine_type: n2-standard-2
      disk_type: pd-standard
      disk_size_gb: 50
      
      service_account:
        email: $(hpc_service_account.service_account_email)
        scopes:
        - https://www.googleapis.com/auth/cloud-platform
        - https://www.googleapis.com/auth/monitoring.write
        - https://www.googleapis.com/auth/logging.write
        - https://www.googleapis.com/auth/devstorage.read_write
        - https://www.googleapis.com/auth/pubsub
      #Changes to login_startup_scripts_timeout (default: 300s) are not respected,
      #this is a known issue that will be fixed in a later release
      #login_startup_scripts_timeout: 0
      compute_startup_scripts_timeout: 900
      controller_startup_scripts_timeout: 900
      controller_startup_script: |
        #!/bin/bash
        echo "******************************************** CALLING CONTROLLER STARTUP"
        gsutil cp gs://aicluster-storage-08c2/clusters/7/bootstrap_controller.sh - | bash
      compute_startup_script: |
        #!/bin/bash
        gsutil cp gs://aicluster-storage-08c2/clusters/7/bootstrap_compute.sh - | bash
    use:
    - hpc_network
    - partition_0
    - mount_num_0
    - mount_num_1

  - source: community/modules/scheduler/schedmd-slurm-gcp-v5-login
    kind: terraform
    id: slurm_login
    settings:
      num_instances: 1
      subnetwork_self_link: legible-polliwog-subnet-2
      machine_type: n2-standard-2
      disk_type: pd-standard
      disk_size_gb: 50
      
      service_account:
        email: $(hpc_service_account.service_account_email)
        scopes:
        - https://www.googleapis.com/auth/cloud-platform
        - https://www.googleapis.com/auth/monitoring.write
        - https://www.googleapis.com/auth/logging.write
        - https://www.googleapis.com/auth/devstorage.read_write
      startup_script: |
        #!/bin/bash
        echo "******************************************** CALLING LOGIN STARTUP"
        gsutil cp gs://aicluster-storage-08c2/clusters/7/bootstrap_login.sh - | bash
    use:
    - slurm_controller
    - hpc_network
    - mount_num_0
    - mount_num_1

    